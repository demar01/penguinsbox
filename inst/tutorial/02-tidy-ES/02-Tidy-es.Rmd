---
title: "Datos ordenados: pivotar a lo largo y pivotar a lo ancho"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
description: >
  Reconoce si tus datos están ordenados y ordénelos si es necesario.
---

<!-- Add JavaScript code for making the exercise code larger -->
<script language="JavaScript" src="js/exercise-font-size.js"></script>

```{r setup, include=FALSE}
# load packages-----------------------------------------------------------------

library(learnr)
library(tidyverse)
library(datos)

# set options for exercises and checking ---------------------------------------

nuevos_pinguinos<- tibble(
     anio = c(2020, 2019, 2019, 2020),
     alto_pico_mm  = c(15,15,20,20),
     largo_pico_mm = c(39.1, 42, 39.5, 37.4))

nuevos_pinguinos2<- tibble(
     anio = c(2018, 2019, 2020,2018, 2019, 2020),
     morfologia=c("alto_pico_mm","alto_pico_mm","alto_pico_mm","largo_pico_mm","largo_pico_mm","largo_pico_mm"),
     valor  = c(15,15,20,39.1, 42, 39.5))

nuevos_pinguinos3<-tibble(
    isla=c("Biscoe","Dream"),
    `2019`=c("3000","4000"),
    `2020`=c("3500","4500"))

mas_pinguinos<- tibble(
     especie  = c( "Adelia",    "Adelie",     "Adelie",    "Adelie"),
     isla  = c( "Biscoe",    "Dream",     "Dream",    "Torgersen"),
     sexo= c("male",NA,NA,"female"),
     medida = c( "alto_pico_mm",    "alto_pico_mm",     "largo_aleta_mm",    "masa_corporal_g"),
     observations=c(39.1,27,180,3750))

# hide non-exercise code chunks ------------------------------------------------
tutorial_options(exercise.timelimit = 60)
knitr::opts_chunk$set(echo = FALSE)
```

## Introducción

```{r imagen-peng, fig.margin = TRUE, echo = FALSE, out.width = "100%", fig.cap="Imagen de Allison Horst"}
knitr::include_graphics("https://raw.githubusercontent.com/allisonhorst/palmerpenguins/master/man/figures/lter_penguins.png")
```

### Objetivos de aprendizaje

El objetivo de este tutorial es mostrar cómo reconocer datos desordenados, así como ordenar datos desordenados utilizando las funciones `pivot_longer` y `pivot_wider` de tidyr.

## Datos ordenados 

Existen tres reglas interrelacionadas que hacen que un conjunto de datos sea ordenado:

- Cada variable debe tener su propia columna.
- Cada observación debe tener su propia fila.
- Cada valor debe tener su propia celda.

```{r datos-ordenados, fig.margin = TRUE, echo = FALSE, out.width = "100%", fig.cap="Figura 12.1 del libro R para ciencia de datos"}
knitr::include_graphics("https://es.r4ds.hadley.nz/diagrams_w_text_as_path/es/tidy-1.svg")
```

```{r echo = TRUE}
nuevos_pinguinos
```

### Test 1 - ¿Cuáles son las variables?

```{r test1, echo = FALSE}
question("¿Cuáles son las variables en el conjunto de datos anterior? Marca todo lo que corresponda.",
         answer("anio", correct = TRUE),
         answer("alto_pico_mm", correct = TRUE),
         answer("largo_pico_mm", correct = TRUE),
         answer("int"),
         answer("dbl"),
         allow_retry = TRUE, 
         correct = "Muy bien! Estos datos nuevos contienen cuatro observaciones medidas con tres variables: anio,isla, largo_pico_mm."
)
```
### Test 2 - ¿Están los datos ordenados?

Considera estos nuevos datos de pinguinos:

```{r echo = TRUE}
mas_pinguinos
```

```{r test2, echo = FALSE}
question("¿Está esta tabla ordenada? ",
         answer("No", correct = TRUE, message = "Si se fija hay variables distintas en una misma columna."),
         answer("Si", message = "No se deje equivocar por que las observaciones esten en una columna distinta de las medidas."),
         allow_retry = TRUE
)
```

## Pivotar a lo ancho

Los datos desordenados son bastante comunes en datasets. Un caso de datos desordenados es cuando una observación aparece en múltiples filas, como por ejemplo en este caso:
<<<<<<< HEAD

```{r echo = TRUE}
nuevos_pinguinos2
```
En este caso cada año tiene una observación, pero la información morfológica está __escondida__ en la columna morfología, de modo que cada observación morfológica aparece en dos filas. En este caso, tenemos que incrementar el  número de columnas y disminuir el número de filas, generando una tabla más ancha pivotando a lo ancho usando `pivot_wider()` para obtener una tabla ordenada. 

```{r}
nuevos_pinguinos2 %>%
    pivot_wider(names_from = morfologia, values_from = valor)
```

## Pivotar a lo largo

Por otra parte, una variable puede estar extendida por varias columnas.
```{r}
nuevos_pinguinos3
```
En este caso tenemos que que angostar la tabla haciendola más larga usando la función `pivot_longer()` 
```{r}
nuevos_pinguinos3 %>% 
  pivot_longer(`2019`:`2020`, names_to = "anio", values_to = "masa_corporal_g")
```
Nótese que en este caso hay que dar nombre a las columnas renombradas.

### 

=======

```{r echo = TRUE}
nuevos_pinguinos2
```
En este caso cada año tiene una observación, pero la información morfológica está __escondida__ en la columna morfología, de modo que cada observación morfológica aparece en dos filas. En este caso, tenemos que incrementar el  número de columnas y disminuir el número de filas, generando una tabla más ancha pivotando a lo ancho usando `pivot_wider()` para obtener una tabla ordenada. 

```{r}
nuevos_pinguinos2 %>%
    pivot_wider(names_from = morfologia, values_from = valor)
```

## Pivotar a lo largo

Por otra parte, una variable puede estar extendida por varias columnas.
```{r}
nuevos_pinguinos3
```
En este caso tenemos que que angostar la tabla haciendola más larga usando la función `pivot_longer()` 
```{r}
nuevos_pinguinos3 %>% 
  pivot_longer(`2019`:`2020`, names_to = "anio", values_to = "masa_corporal_g")
```
Nótese que en este caso hay que dar nombre a las columnas renombradas.

### 

>>>>>>> d55c3841bf6876e00b16c5839788ed44ff0c24f0
Podemos pivotar a lo ancho y a lo largo consecutivamente para volver a tener datos ordenados. Si recordamos los nuevos pinguinos:
```{r echo = TRUE}
nuevos_pinguinos
```
Podemos achatar los datos con `pivot_wider()`:

```{r}
nuevos_pinguinos %>%
  pivot_wider(names_from = anio, values_from = largo_pico_mm)
```
Y volver a un formato ordenado con `pivot_longer()`:
```{r echo = TRUE}
nuevos_pinguinos %>%
  pivot_wider(names_from = anio, values_from = largo_pico_mm) %>%
  pivot_longer(`2019`:`2020`, names_to = "anio", values_to = "largo_pico_mm",
               names_transform = list(anio = as.numeric))
```

## Ejercicio- Reconstruye los datos

```{r echo = FALSE}
nuevos_pinguinos %>% mutate(Sample_Number=1:nrow(nuevos_pinguinos)) %>% pivot_longer(alto_pico_mm:largo_pico_mm)
```
<<<<<<< HEAD
Para crear la tabla mostrada arriba, en primer lugar he aniadido una columna id con el número de fila. Después he pivotado los datos para obtener una table larga. 

Usa functions tidyr para recrear este proceso en el chunk de abajo.
=======
Para crear la tabla mostrada arriba, em primer lugar he aniadido una columna id con el numero de fila. Despues he pivotado los datos para obtener una table larga. 

Use tidyr functions para recrear este proceso en el chunk de abajo.
>>>>>>> d55c3841bf6876e00b16c5839788ed44ff0c24f0

```{r ex3, exercise = TRUE}

```

```{r ex3-hint-1}
<<<<<<< HEAD
nuevos_pinguinos %>%
  mutate(Sample_Number=1:nrow(nuevos_pinguinos))
```


```{r ex3-solution,eval=FALSE}
nuevos_pinguinos %>%
  mutate(Sample_Number=1:nrow(nuevos_pinguinos)) %>% 
  pivot_longer(anio:largo_pico_mm, names_to = "variable", values_to = "valor")
```
=======
nuevos_pinguinos %>%
  mutate(Sample_Number=1:nrow(nuevos_pinguinos))
```


```{r ex3-solution,eval=FALSE}
nuevos_pinguinos %>%
  mutate(Sample_Number=1:nrow(nuevos_pinguinos)) %>% 
  pivot_longer(anio:largo_pico_mm, names_to = "variable", values_to = "valor")
```

###

Nótese que esta tabla no esta ordenada; sin embargo puede resultar fácil filtrar valores en esta tabla, como por ejemplo, selectionar `largo_pico_mm`:
>>>>>>> d55c3841bf6876e00b16c5839788ed44ff0c24f0

```{r ex4, exercise = TRUE}

<<<<<<< HEAD

###

Nótese que esta tabla no esta ordenada; sin embargo puede resultar fácil filtrar valores en esta tabla, como por ejemplo, selectionar `largo_pico_mm`:

```{r ex4, exercise = TRUE}

=======
>>>>>>> d55c3841bf6876e00b16c5839788ed44ff0c24f0
```


```{r ex4-solution,eval=FALSE}
nuevos_pinguinos %>%
  mutate(Sample_Number=1:nrow(nuevos_pinguinos)) %>%
  pivot_longer(anio:largo_pico_mm, names_to = "variable", values_to = "valor") %>% 
  filter(variable=="largo_pico_mm")
```

## En resumen

Trabajar con datos ordenados en R permite utilizar al máximo las functiones vectoriales de R (e.g. mutate y separate y muchas funciones más). Puede ordenar los datos al comienzo de su análisis. Los datos están ordenados si:

- Cada variable debe tener su propia columna.
- Cada observación debe tener su propia fila.
- Cada valor debe tener su propia celda.

Puede usar `pivot_wider()` y `pivot_longer()` o alguna sequencia iterativa de los dos, para remodelar sus datos de manera que:

- Se conserven todos los valores de su conjunto de datos original
- Se retengan todas las relaciones entre valores en su conjunto de datos original.


